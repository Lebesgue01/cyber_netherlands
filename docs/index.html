
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Distribution of Cyberattacks in the Netherlands in 2024</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html,body,#map{height:100%;margin:0;padding:0}
  body{font-family:system-ui,Segoe UI,Roboto,Arial, sans-serif}
  /* map placed to the right of the left sidebar */
  #map{position:absolute;left:300px;top:0;right:0;bottom:0}
  .sidebar {
    position: absolute;
    left: 12px;
    top: 12px;
    width: 276px;
    bottom: 12px;
    background: rgba(255,255,255,0.98);
    border-radius: 8px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    padding: 12px;
    overflow:auto;
    z-index:1000;
  }
  .sidebar h2{margin:6px 0 10px 0;font-size:16px}
  .field{margin-bottom:10px}
  label{display:block;font-size:13px;margin-bottom:4px;color:#222}
  input[type=date], select, input[type=text]{width:100%;padding:6px;border-radius:6px;border:1px solid #ddd}
  .small{font-size:12px;color:#555}
  .legend{position:absolute;right:12px;bottom:12px;background:rgba(255,255,255,0.95);padding:8px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,.12);z-index:1000}
  .dot{width:14px;height:14px;border-radius:50%;display:inline-block;margin-right:8px;vertical-align:middle;border:1px solid #222}
  .popup-company{font-weight:700;font-size:14px;margin-bottom:6px}
  .popup-meta{font-size:13px;color:#333;margin-bottom:6px}
  /* Modal styles (fullscreen, green-on-black) */
  #eduModal { display:none; }
  #eduOverlay {
    position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2000;
  }
  #eduDialog {
    position:fixed; inset:0; width:100%; height:100%; background:#000; color:#00ff66;
    z-index:2001; overflow:auto; display:flex; align-items:center; justify-content:center; padding:28px;
  }
  /* Inner container for image + content */
  #eduInner { display:flex; gap:18px; max-width:1100px; width:100%; }
  #eduImage { width:320px; max-width:38%; height:220px; object-fit:cover; border-radius:8px; border:1px solid #003300 }
  #eduText { flex:1; min-width:220px; }
  #eduDialog h1 { margin:0 0 10px 0; font-size:22px; color:#00ff66; }
  #eduContent { flex:1; overflow:auto; }
  #eduDialog .small { font-size:13px; color:#a8f0b6; }
  #eduCloseBtn { padding:10px 14px; border-radius:6px; border:none; background:#00a64d; color:white; cursor:pointer; }
  #eduCloseBtn[aria-hidden="true"]{ display:none; }
  .simPre { white-space:pre-wrap; background:#000; color:#00ff66; padding:12px; border-radius:6px; overflow:auto; border:1px solid #003300 }
  a.educational-warning { color:#7fffb5; text-decoration:underline; }

  /* Progress bar (green on black) */
  .progressWrap { margin-top:12px; background:#001a00; border:1px solid #003300; border-radius:8px; padding:6px; }
  .progressBar { height:18px; width:100%; background:#000; border-radius:6px; overflow:hidden; }
  .progressFill { height:100%; width:0%; background:linear-gradient(90deg,#00ff66,#00aa44); box-shadow:0 0 8px rgba(0,170,68,0.6); transition:width 0.2s linear; }
  .progressLabel { margin-top:6px; font-size:13px; color:#a8f0b6; }

  /* Second inline alert (appears inside modal) */
  #eduSecondAlert {
    position:fixed; inset:0; z-index:3000; display:none; align-items:center; justify-content:center;
  }
  #eduSecondBox {
    background:#000; border:2px solid #ff8800; color:#ffcc66; padding:22px; border-radius:10px; width:min(760px,94%);
    box-shadow:0 12px 40px rgba(0,0,0,0.8);
  }
  #eduSecondBox h2{margin:0 0 8px 0; font-size:20px; color:#ffcc66}
  #eduSecondBox p{color:#ffdca8; margin:8px 0}

  /* Responsive: stack image on small screens */
  @media (max-width:720px){
    #eduInner{flex-direction:column; align-items:stretch}
    #eduImage{width:100%; height:180px; max-width:none}
  }
</style>
</head>
<body>
<div class="sidebar">
  <h2>Filters — Distribution of Cyberattacks in the Netherlands in 2024</h2>

  <div class="field">
    <label for="dateFrom">Date (from)</label>
    <input id="dateFrom" type="date">
  </div>
  <div class="field">
    <label for="dateTo">Date (to)</label>
    <input id="dateTo" type="date">
  </div>
  <div class="field">
    <label for="attackType">Attack type</label>
    <select id="attackType">
      <option value="ALL">All</option>
      <option value="DDoS">DDoS</option><option value="Ransomware">Ransomware</option><option value="Unknown">Unknown</option>
    </select>
  </div>
  <div class="field">
    <label><input id="stateOnly" type="checkbox"> Only show state-related incidents (state_related)</label>
  </div>
  <div class="field small">
    <label><input id="includeUnknownDates" type="checkbox" checked> Include events without a date</label>
  </div>

  <hr style="margin:12px 0">
  <div class="small">Note: geocoding is performed via Nominatim (results cached locally). If a place can't be geocoded it will appear at the geographic centre of the Netherlands.</div>
  <div class="small">Note: Data mainly extracted from official websites of attacked companies and state services.</div>
</div>

<div id="map"></div>

<div class="legend">
  <div style="font-weight:700;margin-bottom:6px">Legend</div>
  <div style="margin-bottom:6px"><span class="dot" style="background:crimson;border-color:crimson"></span> State-related</div>
  <div style="margin-bottom:6px"><span class="dot" style="background:gold;border-color:gold"></span> AddComm attack</div>
  <div style="margin-bottom:6px"><span class="dot" style="background:grey;border-color:grey"></span> Derived from Addcom attack</div>
  <div><span class="dot" style="background:black;border-color:black"></span> Others</div>
</div>

<!-- Educational fullscreen modal (hidden by default) -->
<div id="eduModal" aria-hidden="true">
  <div id="eduOverlay"></div>
  <div id="eduDialog" role="dialog" aria-modal="true" aria-labelledby="eduTitle" tabindex="-1">
    <div id="eduInner">
      <img id="eduImage" src="C:/Users/bengu/Documents/cyber_nld/image.jpeg" alt="Educational image" />
      <div id="eduText">
        <h1 id="eduTitle">⚠️ Simulated Security Incident — Educational</h1>
        <div id="eduContent">
          <p>This is a message from the <span id="eduPerpStatic">—</span> team.</p>

          <!-- message area: using <div> so inserted HTML (lists & anchors) render properly -->
          <div class="simPre" id="eduPre">Sample incident: "Some service reports data exfiltration after following a malicious link."</div>

          <p class="large">FILE ENCRYPTING PROCESS -- DO NOT TRY TO INTERRUPT</p>

          <div class="progressWrap">
            <div class="progressBar" aria-hidden="true"><div id="eduProgressFill" class="progressFill"></div></div>
            <div id="eduProgressLabel" class="progressLabel">Progress: 0%</div>
          </div>


          <label style="display:block;margin-top:10px; color:#a8f0b6;">
            <input type="checkbox" id="eduAcknowledge"> Stop the encrypting process and open discussion canal with us.
          </label>
          <div style="margin-top:12px;">
            <button id="eduCloseBtn" aria-hidden="true">Close</button>

            <p id="eduDisclaimer" class="small" style="display:none; color:rebeccapurple;">
  This popup is intentionally attention-grabbing for training purposes. Please pay attention before clicking anywhere, it could prevent you from having to deal with real hackers!
</p>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Second ephemeral alert (appears on "Restore instructions") -->
<div id="eduSecondAlert" aria-hidden="true">
  <div id="eduSecondBox" role="dialog" aria-modal="true">
    <h2>Not only you clicked on a dangerous unknown link, but you keep going !</h2>
    <p>This second popup is intentionally blunt: continuing to interact with unknown, coercive instructions increases risk. Close this warning and use official channels to verify any notification.</p>
    <div style="margin-top:12px; text-align:right;">
      <button id="eduSecondClose" style="padding:8px 12px; border-radius:6px; border:none; background:#aa5500; color:white;">Understood</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const rows = [{"date_raw": "Jan 17", "date_iso": "2024-01-17", "place": "Amsterdam", "company": "AerCap", "company_domain": "Aircraft leasing company", "attack_type": "Ransomware", "consequence": "1 TB of data extracted", "perpetrator": "Slug", "Addcom_related": false, "state_related": false, "is_company_addcomm": false, "lat": 52.3730796, "lon": 4.8924534}, {"date_raw": "Feb 15", "date_iso": "2024-02-15", "place": "Oudeschild", "company": "AB Texel", "company_domain": "Logistics company", "attack_type": "Ransomware", "consequence": "No major consequence according to the company", "perpetrator": "Cactus", "Addcom_related": false, "state_related": false, "is_company_addcomm": false, "lat": 53.0383886, "lon": 4.8456912}, {"date_raw": "Feb 19", "date_iso": "2024-02-19", "place": "Leiden", "company": "HAL Allergy", "company_domain": "Pharmaceutical company", "attack_type": "Ransomware", "consequence": "", "perpetrator": "", "Addcom_related": false, "state_related": false, "is_company_addcomm": false, "lat": 52.1594747, "lon": 4.4908843}, {"date_raw": "Feb 26", "date_iso": "2024-02-26", "place": "Renswoude", "company": "EAS Europe", "company_domain": "Mechanical engineering company", "attack_type": "Ransomware", "consequence": "Encrypted data; sensitive data stolen; services shut down", "perpetrator": "", "Addcom_related": false, "state_related": false, "is_company_addcomm": false, "lat": 52.0724219, "lon": 5.5308677}, {"date_raw": "Mar 25", "date_iso": "2024-03-25", "place": "Netherlands", "company": "Public Administration", "company_domain": "Public administration", "attack_type": "DDoS", "consequence": "Websites of several provinces inaccessible", "perpetrator": "", "Addcom_related": false, "state_related": true, "is_company_addcomm": false, "lat": 52.2434979, "lon": 5.6343227}, {"date_raw": "Mar 29", "date_iso": "2024-03-29", "place": "Voorschoten", "company": "Municipality of Voorschoten", "company_domain": "Municipality", "attack_type": "DDoS", "consequence": "Inability to work from home", "perpetrator": "", "Addcom_related": false, "state_related": true, "is_company_addcomm": false, "lat": 52.125722, "lon": 4.4410169}, {"date_raw": "Mar 29", "date_iso": "2024-03-29", "place": "Wassenaar", "company": "Municipality of Wassenaar", "company_domain": "Municipality", "attack_type": "DDoS", "consequence": "Inability to work from home", "perpetrator": "", "Addcom_related": false, "state_related": true, "is_company_addcomm": false, "lat": 52.1425779, "lon": 4.4012224}, {"date_raw": "Mar 1", "date_iso": "2024-03-01", "place": "Nijmegen", "company": "Nexperia", "company_domain": "Chip maker", "attack_type": "Ransomware", "consequence": "Customer data stolen", "perpetrator": "Dunghill Leak", "Addcom_related": false, "state_related": true, "is_company_addcomm": false, "lat": 51.8425749, "lon": 5.8389606}, {"date_raw": "Apr 11", "date_iso": "2024-04-11", "place": "Ede", "company": "Iddink Learning Materials", "company_domain": "Distributor", "attack_type": "Ransomware", "consequence": "Customer data leak, including bank information", "perpetrator": "Cactus", "Addcom_related": false, "state_related": false, "is_company_addcomm": false, "lat": 52.0716825, "lon": 5.7455106}, {"date_raw": "", "date_iso": null, "place": "The Hague", "company": "Europol", "company_domain": "Police Agency", "attack_type": "Unknown", "consequence": "No operational data stolen according to Europol; serious infiltration according to IntelBroker", "perpetrator": "IntelBroker", "Addcom_related": false, "state_related": true, "is_company_addcomm": false, "lat": 52.0749456, "lon": 4.2696802}, {"date_raw": "May 17", "date_iso": "2024-05-17", "place": "Amsterdam", "company": "ABN Amro", "company_domain": "Bank", "attack_type": "Ransomware", "consequence": "Customer data compromised", "perpetrator": "", "Addcom_related": false, "state_related": false, "is_company_addcomm": false, "lat": 52.3730796, "lon": 4.8924534}, {"date_raw": "May 17", "date_iso": "2024-05-17", "place": "s-Hertogenbosch", "company": "Essent", "company_domain": "Energy supply company", "attack_type": "Ransomware", "consequence": "No personal data stolen", "perpetrator": "", "Addcom_related": false, "state_related": false, "is_company_addcomm": false, "lat": 51.6889387, "lon": 5.303116}, {"date_raw": "May 17", "date_iso": "2024-05-17", "place": "Utrecht", "company": "Portaal", "company_domain": "Housing association", "attack_type": "Ransomware", "consequence": "Data stolen", "perpetrator": "", "Addcom_related": true, "state_related": false, "is_company_addcomm": false, "lat": 52.0907006, "lon": 5.1215634}, {"date_raw": "May 17", "date_iso": "2024-05-17", "place": "Amersfoort", "company": "AddComm", "company_domain": "Service provider", "attack_type": "Ransomware", "consequence": "Data stolen", "perpetrator": "", "Addcom_related": false, "state_related": false, "is_company_addcomm": true, "lat": 52.1637702, "lon": 5.4088845}, {"date_raw": "May 17", "date_iso": "2024-05-17", "place": "Schiedam", "company": "Regionale Belasting Groep", "company_domain": "Tax authority", "attack_type": "Ransomware", "consequence": "Data stolen and encrypted", "perpetrator": "", "Addcom_related": true, "state_related": false, "is_company_addcomm": false, "lat": 51.91718, "lon": 4.4019149}, {"date_raw": "May 17", "date_iso": "2024-05-17", "place": "Heerhugowaard", "company": "Hoogheemraadschap Hollands Noorderkwartier", "company_domain": "Water authority", "attack_type": "Ransomware", "consequence": "Data stolen", "perpetrator": "", "Addcom_related": true, "state_related": false, "is_company_addcomm": false, "lat": 52.6631484, "lon": 4.8326672}, {"date_raw": "May 17", "date_iso": "2024-05-17", "place": "Groningen", "company": "Waterbedrijf Groningen", "company_domain": "Water utility", "attack_type": "Ransomware", "consequence": "Customer data compromised", "perpetrator": "", "Addcom_related": true, "state_related": false, "is_company_addcomm": false, "lat": 53.2190652, "lon": 6.5680077}, {"date_raw": "May 17", "date_iso": "2024-05-17", "place": "Assen", "company": "WMD Drinkwater", "company_domain": "Water utility", "attack_type": "Ransomware", "consequence": "Data stolen", "perpetrator": "", "Addcom_related": true, "state_related": false, "is_company_addcomm": false, "lat": 52.997225, "lon": 6.5506458}, {"date_raw": "June 1", "date_iso": "2024-06-01", "place": "Netherlands", "company": "", "company_domain": "Political websites", "attack_type": "DDoS", "consequence": "Services unavailable", "perpetrator": "HackNet", "Addcom_related": false, "state_related": true, "is_company_addcomm": false, "lat": 52.2434979, "lon": 5.6343227}, {"date_raw": "Sep 1", "date_iso": "2024-09-01", "place": "Haarlemmermeer", "company": "Kawasaki Motors Europe", "company_domain": "Car manufacturer", "attack_type": "Ransomware", "consequence": "500 GB data stolen", "perpetrator": "RansomHub", "Addcom_related": false, "state_related": false, "is_company_addcomm": false, "lat": 52.3238421, "lon": 4.7152612}, {"date_raw": "Sep 1", "date_iso": "2024-09-01", "place": "Netherlands", "company": "Police of the Netherlands", "company_domain": "Police", "attack_type": "Unknown", "consequence": "No sensitive data stolen", "perpetrator": "", "Addcom_related": false, "state_related": true, "is_company_addcomm": false, "lat": 52.2434979, "lon": 5.6343227}, {"date_raw": "Dec 1", "date_iso": "2024-12-01", "place": "Houten", "company": "Bnext", "company_domain": "Waste recycling company", "attack_type": "Unknown", "consequence": "500 GB data leak", "perpetrator": "Black Basta", "Addcom_related": false, "state_related": false, "is_company_addcomm": false, "lat": 52.0271433, "lon": 5.1620637}];

  function markerColor(r){
    if(r.state_related) return 'crimson';
    if(r.is_company_addcomm) return 'gold';
    if(r.Addcom_related) return 'grey';
    return 'black';
  }

  const map = L.map('map').setView([52.09,5.12],7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  let markersLayer = L.layerGroup().addTo(map);

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function ensureFullUrl(u){
    if(!u) return '';
    try{ if(u.match(/^https?:\/\//i)) return u; }catch(e){}
    return 'https://' + u.replace(/^\/+/, '');
  }

  function makePopupHtml(r){
    const dateText = r.date_iso ? new Date(r.date_iso).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}) : (r.date_raw || 'Unknown date');
    const place = r.place || '—';
    const company = r.company || '—';
    const perpetrator = r.perpetrator || '—';
    const consequence = r.consequence || '—';

    // Prefer a real company domain if available, otherwise fallback to example.com/report/123
    let rawUrl = (r.company_domain && r.company_domain.trim()) ? r.company_domain.trim() : 'https://example.com/report/123';
    rawUrl = ensureFullUrl(rawUrl);

    // For the 'about' (video) link, if the company_domain looks like a YouTube url use it
    let yt_candidate = '';
    if(r.company_domain && /youtube\.com|youtu\.be/i.test(r.company_domain)) {
      yt_candidate = ensureFullUrl(r.company_domain.trim());
    }

    const displayUrlText = escapeHtml(rawUrl);

    // Anchor transports metadata that the modal will consume. We keep href so user sees actual link on hover.
    return `
      <div class="popup-company">${escapeHtml(company)}</div>
      <div class="popup-meta">${escapeHtml(place)} — ${escapeHtml(dateText)}</div>
      <div><strong>Perpetrator:</strong> ${escapeHtml(perpetrator)}</div>
      <div><strong>Consequence:</strong> ${escapeHtml(consequence)}</div>
      <div style="margin-top:8px;">
        Source: <a href="${escapeHtml(rawUrl)}" target="_blank" rel="noopener noreferrer" class="educational-warning"
                  data-title="${escapeHtml("YOUR FILES ARE GETTING ENCRYPTED")}"
                  data-yt="${escapeHtml(yt_candidate)}"
                  data-orig="${escapeHtml(rawUrl)}"
                  data-company="${escapeHtml(company)}"
                  data-perp="${escapeHtml(perpetrator)}"
                  data-date="${escapeHtml(dateText)}"
                  >${displayUrlText}</a>
      </div>
    `;
  }

  function renderMarkers(){
    markersLayer.clearLayers();
    const attackFilter = document.getElementById('attackType').value;
    const stateOnly = document.getElementById('stateOnly').checked;
    const includeUnknownDates = document.getElementById('includeUnknownDates').checked;
    const dateFrom = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value) : null;
    const dateTo = document.getElementById('dateTo').value ? new Date(document.getElementById('dateTo').value) : null;

    const toShow = rows.filter(r=>{
      if(stateOnly && !r.state_related) return false;
      if(attackFilter && attackFilter !== 'ALL' && (r.attack_type || '').trim() !== attackFilter) return false;
      const dt = r.date_iso ? new Date(r.date_iso) : null;
      if(dt){
        if(dateFrom && dt < dateFrom) return false;
        if(dateTo && dt > dateTo) return false;
      } else {
        if(!includeUnknownDates) return false;
      }
      return true;
    });

    const latlngs = [];
    toShow.forEach(r=>{
      const lat = r.lat || 52.132633;
      const lon = r.lon || 5.291266;
      const color = markerColor(r);
      const marker = L.circleMarker([lat,lon], { radius:8, fill:true, fillColor:color, color:color, weight:1, fillOpacity:0.95 });
      marker.bindPopup(makePopupHtml(r));
      marker.addTo(markersLayer);
      latlngs.push([lat,lon]);
    });

    if(latlngs.length>0){
      const bounds = L.latLngBounds(latlngs);
      map.fitBounds(bounds.pad(0.2));
    } else {
      map.setView([52.09,5.12],7);
    }
  }

  // default date range: full year 2024
  document.getElementById('dateFrom').value = '2024-01-01';
  document.getElementById('dateTo').value = '2024-12-31';

  // Immediate filtering: call renderMarkers on input/change events
  document.getElementById('dateFrom').addEventListener('input', renderMarkers);
  document.getElementById('dateTo').addEventListener('input', renderMarkers);
  document.getElementById('attackType').addEventListener('change', renderMarkers);
  document.getElementById('stateOnly').addEventListener('change', renderMarkers);
  document.getElementById('includeUnknownDates').addEventListener('change', renderMarkers);

  // initial render
  renderMarkers();

  // --- Educational modal logic (fullscreen behaviour + show Close only after ack) ---
(function(){
  const modalWrap = document.getElementById('eduModal');
  const ackCheckbox = document.getElementById('eduAcknowledge');
  const closeBtn = document.getElementById('eduCloseBtn');
  const eduPre = document.getElementById('eduPre'); // message container (HTML)
  const eduTitle = document.getElementById('eduTitle');
  const eduFill = document.getElementById('eduProgressFill');
  const eduLabel = document.getElementById('eduProgressLabel');

  const secondAlertWrap = document.getElementById('eduSecondAlert');
  const secondClose = document.getElementById('eduSecondClose');
  const perpSpan = document.getElementById('eduPerpStatic');

  let progressTimer = null;
  let currentYt = '';
  let currentOrig = '';
  let currentPerp = '';
  let currentDateText = '';

  function setProgress(p){
    const pct = Math.max(0, Math.min(99, Math.round(p)));
    eduFill.style.width = pct + '%';
    eduLabel.textContent = 'Progress: ' + pct + '%';
  }

  function startProgress(){
    let progress = 0;
    setProgress(progress);
    if(progressTimer) clearTimeout(progressTimer);

    function step(){
      const remaining = 99 - progress;
      if(remaining <= 0){
        setProgress(99);
        progressTimer = null;
        return;
      }
      const maxStep = Math.max(0.06, remaining / 80);
      const stepAmt = (Math.random() * maxStep) + (Math.random() < 0.22 ? Math.random() * 0.6 : 0);
      progress = Math.min(99, progress + stepAmt);
      setProgress(progress);

      let delay = 800 + Math.random() * 2600;
      if(Math.random() < 0.18) delay += 800 + Math.random() * 2600;
      progressTimer = setTimeout(step, delay);
    }

    const initialDelay = 500 + Math.random() * 900;
    progressTimer = setTimeout(step, initialDelay);
  }

  function resetProgress(){
    if(progressTimer) clearTimeout(progressTimer);
    progressTimer = null;
    setProgress(0);
  }

  // helper to sanitize a name for inclusion in a fake URL segment
  function sanitizeForUrl(s){
    if(!s) return 'unknown';
    return String(s).trim().replace(/\s+/g, '_').replace(/[^A-Za-z0-9_\-]/g, '') || 'unknown';
  }

  async function openEduModalFromAnchor(anchor){
  // read attributes (robust fallbacks)
  const title = anchor.getAttribute('data-title') || 'YOUR FILES ARE GETTING ENCRYPTED';
  const yt = anchor.getAttribute('data-yt') || '';
  const orig = anchor.getAttribute('data-orig') || '';
  // prefer explicit data-perp, else company, else ''
  const perpAttr = anchor.getAttribute('data-perp');
  const companyAttr = anchor.getAttribute('data-company');
  const perp = (perpAttr && perpAttr.trim()) ? perpAttr.trim() : ((companyAttr && companyAttr.trim()) ? companyAttr.trim() : '');
  const dateText = anchor.getAttribute('data-date') || '';

  // decide display name (use Lockit when unknown)
  const displayPerp = (perp && perp.length > 0) ? perp : 'Lockit';

  // store for handlers (use displayPerp so handlers see fallback name)
  currentYt = yt || '';
  currentOrig = orig || '';
  currentPerp = displayPerp;
  currentDateText = dateText || '';

  // show perp in the header zone
  if(perpSpan) perpSpan.textContent = displayPerp;

  // set modal title
  eduTitle.textContent = title;

  // construct disguised (display) URLs but keep actual click behaviour separate
  const perpForUrl = sanitizeForUrl(displayPerp);
  const restoreDisplay = 'https://restore_file_help_plan.com';
  const aboutDisplay = 'https://communication_' + perpForUrl + '_group.com';

  // build HTML message (we escape dynamic bits)
  const messageHtml =
    '<p>Don\'t worry, you can return all your files!</p>' +
    '<p>If you want to restore them follow this link: <a href="#" class="eduInlineRestore">' + escapeHtml(restoreDisplay) + '</a></p>' +
    '<p><strong>Attention</strong></p>' +
    '<ul>' +
      '<li>Do not rename encrypted files</li>' +
      '<li>Do not try to decrypt your data using third party software, it may cause permanent data loss</li>' +
      '<li>Decryption of your file with the help of third parties may cause increased price</li>' +
    '</ul>' +
    '<p>Learn more about the ' + escapeHtml(displayPerp) + ' team at <a href="#" class="eduInlineAbout">' + escapeHtml(aboutDisplay) + '</a></p>';

  // put HTML into message container
  eduPre.innerHTML = messageHtml;

  // ensure disclaimer hidden at modal open
  const disclaimer = document.getElementById('eduDisclaimer');
  if(disclaimer) disclaimer.style.display = 'none';

  // reset ack / close visibility, show modal
  ackCheckbox.checked = false;
  closeBtn.setAttribute('aria-hidden','true');
  closeBtn.style.display = 'none';
  modalWrap.style.display = 'block';
  modalWrap.setAttribute('aria-hidden','false');
  document.getElementById('eduDialog').focus();

  // start progress simulation
  startProgress();

  // attach handlers to inline links injected above

  // Restore: exit fullscreen if active, THEN show the second didactic alert
  const inlineRestore = modalWrap.querySelector('.eduInlineRestore');
  if(inlineRestore){
    inlineRestore.addEventListener('click', async function(ev){
      ev.preventDefault();
      try {
        if(document.fullscreenElement){
          await document.exitFullscreen();
        }
      } catch(err){
        console.warn('exitFullscreen failed:', err);
      }
      setTimeout(function(){
        secondAlertWrap.style.display = 'flex';
        secondAlertWrap.setAttribute('aria-hidden','false');
      }, 120);
    });
  }

  // About: open data-yt if provided, otherwise rickroll (but text stays the disguised aboutDisplay)
  const inlineAbout = modalWrap.querySelector('.eduInlineAbout');
  if(inlineAbout){
    inlineAbout.addEventListener('click', function(ev){
      ev.preventDefault();
      const rick = 'https://www.youtube.com/watch?v=dQw4w9WgXcQ';
      if(currentYt && currentYt.trim()){
        window.open(currentYt, '_blank', 'noopener');
      } else {
        window.open(rick, '_blank', 'noopener');
      }
    });
  }

  // Try to request fullscreen (best-effort; browsers only allow in user gesture contexts)
  try{
    const el = document.getElementById('eduDialog');
    if(el.requestFullscreen){
      await el.requestFullscreen();
    }
  }catch(err){
    console.warn('Fullscreen request failed or was denied:', err);
  }
}


  function closeEduModal(){
    modalWrap.style.display = 'none';
    modalWrap.setAttribute('aria-hidden','true');
    try{
      if(document.fullscreenElement){
        document.exitFullscreen();
      }
    }catch(e){/* ignore */}
    resetProgress();
  }

  // second alert controls
  secondClose.addEventListener('click', function(){
    secondAlertWrap.style.display = 'none';
    secondAlertWrap.setAttribute('aria-hidden','true');
  });

  // --- replace existing ackCheckbox 'change' handler with this ---
ackCheckbox.addEventListener('change', function(){
  const disclaimer = document.getElementById('eduDisclaimer');
  if(this.checked){
    // show Close button
    closeBtn.style.display = 'inline-block';
    closeBtn.removeAttribute('aria-hidden');
    closeBtn.focus();

    // show the disclaimer at the same time (styled in purple)
    if(disclaimer){
      disclaimer.style.display = 'block';
      disclaimer.style.color = 'rebeccapurple';
      // optional: make it slightly more visible (increase weight)
      disclaimer.style.fontWeight = '600';
    }
  } else {
    // hide Close button again
    closeBtn.setAttribute('aria-hidden','true');
    closeBtn.style.display = 'none';

    // hide disclaimer again
    if(disclaimer){
      disclaimer.style.display = 'none';
    }
  }
});


  closeBtn.addEventListener('click', function(){
    closeEduModal();
  });

  // Delegate clicks on links with class 'educational-warning' (popup anchors)
  document.addEventListener('click', function(ev){
    const a = ev.target.closest && ev.target.closest('a.educational-warning');
    if(!a) return;
    ev.preventDefault(); // stop normal navigation
    openEduModalFromAnchor(a);
  }, false);

  // Prevent Escape from closing modal (best-effort)
  document.addEventListener('keydown', function(ev){
    if(ev.key === 'Escape'){
      if(modalWrap.style.display === 'block'){
        ev.preventDefault();
        ev.stopPropagation();
      }
    }
  }, true);

  // Keep listening to fullscreenchange purely for awareness (no auto-close):
  document.addEventListener('fullscreenchange', function(){
    if(!document.fullscreenElement){
      // user exited fullscreen — modal stays visible; we do not auto-close it.
    }
  });

})(); // end IIFE


</script>
</body>
</html>
